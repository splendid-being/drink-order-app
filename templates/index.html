<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>음료 주문</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
<div style="text-align: center; margin-top: 10px;">
    <button onclick="toggleNews()" style="background: none; border: none; color: #1e90ff; font-size: 14px; cursor: pointer;">
        &#x1F4E2; 소식 보기
    </button>
    <p id="news-msg" style="display: none; font-size: 16px; color: #e74c3c; font-weight: bold; margin-top: 8px;">
        &#x1F389; (경축) 윤중석 인턴, 한국자산관리공사 캠코 입사!  (경축) &#x1F389;
    </p>
</div>
    <h1>음료 주문</h1>
    <div class="container">
        <div class="box">
            <form method="post" style="position: relative;">
                <div class="cafe-select">
                    <input type="radio" id="b1" name="location" value="B1" required>
                    <label for="b1" class="cafe-option">&#x2615; 칸틴 (지하 1층)</label>

                    <input type="radio" id="2f" name="location" value="2F" required>
                    <label for="2f" class="cafe-option">&#x1F964; 2층 카페</label>

                    <input type="radio" id="sand" name="location" value="SAND" required>
                    <label for="sand" class="cafe-option">&#x1F3D6;&#xFE0F; Sand Coffee</label>
                </div>

                <input type="text" name="name" placeholder="이름 입력" maxlength="10" required>
                <input type="text" name="drink" id="drink-input" placeholder="음료 입력" maxlength="20" required>
                <small style="color: #777; font-size: 13px; margin-top: -5px;">
                    &#x2328; 이제 방향키와 Enter로 자동완성 항목을 선택할 수 있어요!
                </small>
                <div id="suggestions"></div>
                <div id="bean-section" style="display: none;">
                    <label for="bean">&#x1F331; 원두 선택</label>
                    <select name="bean" id="bean">
                        <option value="">-- 원두를 선택해주세요 --</option>
                    </select>
                </div>
                <div id="error-msg" class="error-msg">이름과 음료를 모두 입력해주세요.</div>
                <div id="bean-error" class="error-msg">원두를 선택해주세요.</div>
                <div class="temp-buttons">
                    <button type="button" name="temperature" value="아이스" class="ice">&#x1F9CA; 아이스</button>
                    <button type="button" name="temperature" value="따뜻한" class="hot">&#x1F525; 핫</button>
                </div>
            </form>
            {% if orders %}
            <h3>주문 현황</h3>
            <ul>
                {% for idx, order in enumerate(orders) %}
                <li class="{{ 'ice-border' if order['temperature'] == '아이스' else 'hot-border' }}">
                    <div class="drink-info">
                        {{ idx+1 }}. <strong>{{ order['name'] }}</strong> → {{ order['temperature'] }} {{
                        order['drink'].replace(' ', '') }}
                        {% if order.get('bean') %}
                        - {{ order['bean'] }}
                        {% endif %}
                    </div>
                    <form method="post" action="/delete" class="delete-form">
                        <input type="hidden" name="index" value="{{ idx }}">
                        <button class="delete-button">삭제</button>
                    </form>
                </li>
                {% endfor %}
            </ul>
            {% endif %}
        </div>
        <div class="box">
            <h3>&#x1F4DD; 주문판</h3>
            {% if summary %}
            <ul>
                {% for item, count in summary.items() %}
                <li class="{{ 'ice-border' if '아이스' in item else 'hot-border' }}"> {{ item }}: {{ count }}잔</li>
                {% endfor %}
            </ul>
            {% else %}
            <p>주문이 아직 없습니다.</p>
            {% endif %}
        </div>

    </div>

    <!-- 메뉴판 이미지 -->
    <div style="text-align: center; margin-top: 40px;">
        <h2 style="margin-bottom: 20px; color: #333;">&#x1F4CB; 메뉴판</h2>
        <div style="display: flex; justify-content: center; gap: 20px; flex-wrap: wrap;">
            <div>
                <p style="margin-bottom: 8px; color: #333; font-weight: bold;">칸틴 (지하 1층)</p>
                <img src="{{ url_for('static', filename='menu.jpg') }}" alt="지하1층 메뉴판" class="menu-img">
            </div>
            <div>
                <p style="margin-bottom: 8px; color: #333; font-weight: bold;">2층 카페</p>
                <img src="{{ url_for('static', filename='2F_menu.jpeg') }}" alt="2층 메뉴판" class="menu-img">
            </div>
            <div>
                <p style="margin-bottom: 8px; color: #333; font-weight: bold;">Sand Coffee - Menu 1</p>
                <img src="{{ url_for('static', filename='sand_coffee_menu1.jpg') }}" alt="Sand Coffee 메뉴판 1" class="menu-img">
            </div>
            <div>
                <p style="margin-bottom: 8px; color: #333; font-weight: bold;">Sand Coffee - Menu 2</p>
                <img src="{{ url_for('static', filename='sand_coffee_menu2.jpg') }}" alt="Sand Coffee 메뉴판 2" class="menu-img">
            </div>
        </div>
        <p style="color: #555; margin-top: 10px;">※ 메뉴판을 클릭하면 확대됩니다</p>
    </div>

    <!-- 모달 이미지 확대 -->
    <div id="img-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
         background-color: rgba(0,0,0,0.8); z-index: 9999; justify-content: center; align-items: center;">
        <img id="modal-img" src="" alt="확대 메뉴판"
            style="max-width: 90%; max-height: 90%; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.4);">
    </div>

    <script>
        const drinkInput = document.getElementById('drink-input');
        const suggestions = document.getElementById('suggestions');
        const beanSection = document.getElementById('bean-section');
        const beanError = document.getElementById('bean-error');
        const beanSelect = document.getElementById('bean');

        // 백엔드에서 가져온 데이터를 저장할 변수
        let drinkList = [];
        let coffeeDrinks = [];

        // 음료명 정제 함수 (온도 단어 제거)
        function cleanDrinkName(text) {
            return text.replace(/(아이스|핫|뜨거운|따뜻한)\s*/gi, '').trim();
        }

        // 정규화 함수 (소문자 + 공백 제거)
        function normalize(text) {
            return text.toLowerCase().replace(/\s+/g, '');
        }

        // 백엔드 API에서 메뉴 데이터 가져오기
        async function loadMenuData(location) {
            try {
                const response = await fetch(`/api/menu/${location}`);
                if (!response.ok) {
                    throw new Error('Failed to load menu data');
                }
                const data = await response.json();
                
                // 전역 변수에 저장
                drinkList = data.drinks;
                coffeeDrinks = data.coffee_drinks;
                
                // 원두 선택 드롭다운 업데이트
                beanSelect.innerHTML = '<option value="">-- 원두를 선택해주세요 --</option>';
                data.beans.forEach((bean) => {
                    const option = document.createElement("option");
                    option.value = bean;
                    option.textContent = bean;
                    beanSelect.appendChild(option);
                });
                
                console.log(`[INFO] ${location} 메뉴 데이터 로드 완료`);
            } catch (error) {
                console.error('[ERROR] 메뉴 데이터 로드 실패:', error);
                alert('메뉴 데이터를 불러오는데 실패했습니다. 새로고침 해주세요.');
            }
        }

        // 카페 선택 시 이벤트 리스너
        document.querySelectorAll('input[name="location"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                const selectedLocation = e.target.value;
                loadMenuData(selectedLocation);

                // 필드 초기화
                drinkInput.value = "";
                suggestions.innerHTML = "";
                beanSection.style.display = "none";
            });
        });

        let currentFocus = -1;

        // 음료 입력 시 자동완성
        drinkInput.addEventListener('input', () => {
            const raw = drinkInput.value;
            const cleaned = cleanDrinkName(raw);
            const normalized = normalize(cleaned);

            suggestions.innerHTML = "";
            currentFocus = -1;

            // 자동완성 추천 표시
            if (normalized.length > 0) {
                const matched = drinkList.filter(item => normalize(item).includes(normalized));
                matched.slice(0, 5).forEach(match => {
                    const div = document.createElement('div');
                    div.textContent = match;
                    div.tabIndex = -1;
                    div.classList.add('autocomplete-item');
                    div.addEventListener('mousedown', (e) => {
                        e.preventDefault();
                        drinkInput.value = match;
                        suggestions.innerHTML = "";
                        
                        // 자동완성 클릭 후 원두 조건 확인
                        const cleaned = cleanDrinkName(match);
                        const normalized = normalize(cleaned);
                        const isCoffee = coffeeDrinks.map(normalize).includes(normalized);

                        if (isCoffee) {
                            beanSection.style.display = 'block';
                        } else {
                            beanSection.style.display = 'none';
                            beanError.style.display = 'none';
                            beanSelect.value = '';
                        }
                    });
                    suggestions.appendChild(div);
                });
            }

            const isCoffee = coffeeDrinks.map(normalize).includes(normalized);
            if (isCoffee) {
                beanSection.style.display = 'block';
            } else {
                beanSection.style.display = 'none';
                beanError.style.display = 'none';
                beanSelect.value = '';
            }
        });

        // 키보드 네비게이션
        drinkInput.addEventListener('keydown', (e) => {
            const items = suggestions.querySelectorAll('div');
            if (e.key === 'ArrowDown') {
                currentFocus++;
                if (currentFocus >= items.length) currentFocus = 0;
                setActive(items);
                e.preventDefault();
            } else if (e.key === 'ArrowUp') {
                currentFocus--;
                if (currentFocus < 0) currentFocus = items.length - 1;
                setActive(items);
                e.preventDefault();
            } else if (e.key === 'Enter') {
                if (currentFocus > -1 && items[currentFocus]) {
                    const selected = items[currentFocus].textContent;
                    drinkInput.value = selected;
                    suggestions.innerHTML = "";
                    e.preventDefault();

                    // 원두 선택 조건 다시 평가
                    const cleaned = cleanDrinkName(selected);
                    const normalized = normalize(cleaned);
                    const isCoffee = coffeeDrinks.map(normalize).includes(normalized);

                    if (isCoffee) {
                        beanSection.style.display = 'block';
                    } else {
                        beanSection.style.display = 'none';
                        beanError.style.display = 'none';
                        beanSelect.value = '';
                    }
                }
            } else if (e.key === 'Escape') {
                suggestions.innerHTML = "";
            }
        });

        function setActive(items) {
            if (!items || items.length === 0) return;
            items.forEach(item => item.classList.remove('active'));
            if (currentFocus >= 0 && currentFocus < items.length) {
                items[currentFocus].classList.add('active');
                items[currentFocus].scrollIntoView({ block: 'nearest' });
            }
        }

        document.addEventListener('click', (e) => {
            if (!suggestions.contains(e.target) && e.target !== drinkInput) {
                suggestions.innerHTML = "";
            }
        });

        // 버튼 throttle 처리
        function throttle(func, limit) {
            let lastCall = 0;
            return function (e) {
                e.preventDefault();
                const now = Date.now();
                if (now - lastCall >= limit) {
                    lastCall = now;
                    func.call(this, e);
                }
            };
        }

        const buttons = document.querySelectorAll('.temp-buttons button');
        const throttledSubmit = throttle(function (e) {
            const form = e.target.closest('form');
            const name = form.querySelector('input[name="name"]').value.trim();
            const drink = form.querySelector('input[name="drink"]').value.trim();
            const bean = form.querySelector('select[name="bean"]').value.trim();
            const errorMsg = document.getElementById("error-msg");

            if (!name || !drink) {
                errorMsg.style.display = "block";
                return;
            } else {
                errorMsg.style.display = "none";
            }

            const cleaned = cleanDrinkName(drink);
            const normalized = normalize(cleaned);
            const isCoffee = coffeeDrinks.map(normalize).includes(normalized);

            console.log("[DEBUG] cleaned:", cleaned);
            console.log("[DEBUG] normalized:", normalized);
            console.log("[DEBUG] isCoffee:", isCoffee);
            console.log("[DEBUG] bean:", bean);

            if (isCoffee && !bean) {
                beanError.style.display = "block";
                return;
            } else {
                beanError.style.display = "none";
            }

            const temperature = e.target.value;
            const hidden = document.createElement('input');
            hidden.type = 'hidden';
            hidden.name = 'temperature';
            hidden.value = temperature;
            form.appendChild(hidden);

            form.submit();
        }, 1000);
        
        buttons.forEach(button => button.addEventListener('click', throttledSubmit));

        // 메뉴판 확대
        document.querySelectorAll('.menu-img').forEach(img => {
            img.addEventListener('click', () => {
                document.getElementById('modal-img').src = img.src;
                document.getElementById('img-modal').style.display = 'flex';
            });
        });
        
        document.getElementById('img-modal').addEventListener('click', () => {
            document.getElementById('img-modal').style.display = 'none';
        });

        function toggleNews() {
            const msg = document.getElementById('news-msg');
            msg.style.display = (msg.style.display === 'none') ? 'block' : 'none';
        }

    </script>
</body>

</html>